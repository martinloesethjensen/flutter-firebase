
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>Flutter Firebase Codelab</title>
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://storage.googleapis.com/codelab-elements/codelab-elements.css">
  <style>
    .success {
      color: #1e8e3e;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <google-codelab-analytics gaid="UA-49880327-14"></google-codelab-analytics>
  <google-codelab codelab-gaid="228626780"
                  id="flutter-firebase-codelab"
                  title="Flutter Firebase Codelab"
                  environment="web"
                  feedback-link="https://github.com/martinloesethjensen/flutter-firebase/issues/new">
    
      <google-codelab-step label="Overview" duration="0">
        <p>In this codelab we want to show how to implement Firebase into a Flutter app.</p>
<p>We will build a chat app where users can log in / sign in with Firebase, interact with Firestore, upload images to Firebase Storage, push notifications and analytics.</p>
<p>We will show how to setup up the app with Firebase and how to create a Firebase project.</p>
<p>You can jump down to the Firebase section by following <a href="https://martinjensen.tech/flutter-firebase/#0" target="_blank">this link</a>.</p>


      </google-codelab-step>
    
      <google-codelab-step label="Prerequisite" duration="0">
        <p>Have a Google account that you will use for login to Firebase.<br>See the official prerequisites on the <a href="https://firebase.google.com/docs/flutter/setup#prerequisites" target="_blank">Firebase documentation</a></p>
<p>You can <a href="https://github.com/martinloesethjensen/flutter-firebase" target="_blank">download the project from GitHub</a>.</p>
<p>Be able to run Flutter on either a simulator or physical device.<br>You can follow the steps in the Flutter website: <a href="https://flutter.dev/docs/get-started" target="_blank">Getting Started</a></p>
<aside class="special"><p>It is important to note that if you need to run an Android emulator then you need to install and <a href="https://flutter.dev/docs/get-started/install/macos#set-up-the-android-emulator" target="_blank">setup up the Android emulator in Android Studio</a></p>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="Create a Flutter Project" duration="0">
        <p>When you have <a href="https://flutter.dev/docs/get-started/install" target="_blank">Flutter setup</a> on your computer then you are ready to create the Flutter project.</p>
<p>With this simple Flutter command you will create a sample / &#34;skeleton&#34; app and will be able to run right after creation.</p>
<pre><code>flutter create gdg_flutter_firebase_chat
</code></pre>
<p>You can run the app from the terminal or run it in an IDE such as Android Studio, Intellij IDEA or VS Code (these editors has plugins for Flutter and dart support).<br>In the terminal navigate to the newly created project, <code>gdg_flutter_firebase_chat</code>, and run the <code>flutter run</code> command.</p>
<pre><code>cd gdg_flutter_firebase_chat
flutter run
</code></pre>
<aside class="special"><p><strong>Note:</strong> you need to have a device or emulator connected / started for the app to run.<br>You can find <a href="https://gist.github.com/martinloesethjensen/8b53ec97834aaea2622d57ec94d3fb5e" target="_blank">useful Flutter commands here</a>.</p>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="Start Building" duration="0">
        <p>Now that we can run our Flutter code on an emulator or device, we will try to build something for ourself.<br>We will now remove all the code in the <code>main.dart</code> file and fill in with this code below.</p>
<pre><code>import &#39;package:flutter/material.dart&#39;;
 
void main() {
  runApp(
    MaterialApp(
      title: &#34;GDG Firebase chat&#34;,
      home: Scaffold(
        appBar: AppBar(
          title: Text(&#34;GDG Firebase chat&#34;),
        ),
      ),
    ),
  );
}
</code></pre>
<p>Let us delete the <code>test</code> folder as we will not be needing that in this codelab.<br>You can do it via the terminal, folder or IDE.</p>
<p>In the terminal you can use this command:</p>
<pre><code>rm -r test/
</code></pre>
<p>Now we will create a new folder in the <code>lib</code> folder. Let us name the folder <code>helpers</code>, and the purpose of this folder is to have files with code that will be used throughout the project. Such an example could be constants like colours.</p>
<p>You can do it via the terminal, folder or IDE.</p>
<p>In the terminal you can use this command:</p>
<pre><code>cd lib
mkdir helpers
</code></pre>
<p>While we are at it we will make a new dart file in that folder, <code>app_constants.dart</code>.</p>
<p>Your structure should look like this.</p>
<p class="image-container"><img alt="folder_structure_01" src="img/f4c3251491688f63.png"></p>
<p>In <code>app_constants.dart</code> we will create a class called <code>AppConstants</code> which will have <code>static</code> fields that we can access throughout the app.</p>
<pre><code>import &#39;package:flutter/material.dart&#39;;

class AppConstants {
  static const String APP_PRIMARY_COLOR = &#34;#EB342E&#34;;
  static const String APP_BACKGROUND_COLOR = &#34;#F6F8F9&#34;;
  static const String APP_BACKGROUND_COLOR_WHITE = &#34;#FFFFFF&#34;;
  static const String APP_PRIMARY_COLOR_LIGHT = &#34;#9f9f9f&#34;;
  static const String APP_PRIMARY_COLOR_BLACK = &#34;#000000&#34;;
  static const String APP_PRIMARY_FONT_COLOR_WHITE = &#34;#FFFFFF&#34;;
  static const String APP_PRIMARY_COLOR_ACTION = &#34;#BC2923&#34;;
  static const String APP_PRIMARY_ROOM_COLOR = &#34;#707070&#34;;
  static const String APP_PRIMARY_COLOR_GREEN = &#34;#009099&#34;;
  static const String APP_BACKGROUND_COLOR_GRAY = &#34;#D0D0D0&#34;;

  static Color hexToColor(String code) {
    return Color(int.parse(code.substring(1, 7), radix: 16) + 0xFF000000);
  }
}

</code></pre>
<p>Now we will update the theme of the app with the colors we want. We have our colors in the <code>AppConstants</code>class.<br>We update the <code>theme</code> field in the <code>MaterialApp(...)</code> in our <code>main.dart</code> file.</p>
<p>Remember to import app_constants in the import section in the top of the file.</p>
<pre><code>import &#39;package:flutter/material.dart&#39;;
import &#39;package:gdg_flutter_firebase_chat/helpers/app_constants.dart&#39;;  
 
void main() {
  runApp(
    MaterialApp(
      title: &#34;GDG Firebase chat&#34;,
      theme: ThemeData(
        primaryColor: AppConstants.hexToColor(AppConstants.APP_PRIMARY_COLOR),
        backgroundColor:
            AppConstants.hexToColor(AppConstants.APP_BACKGROUND_COLOR),
        primaryColorLight:
            AppConstants.hexToColor(AppConstants.APP_PRIMARY_COLOR_LIGHT),
        accentColor: Colors.black,
        accentIconTheme: IconThemeData(color: Colors.black),
        dividerColor: Colors.black12,
        textTheme: TextTheme(
          caption: TextStyle(color: Colors.white),
        ),
      ),
      home: Scaffold(
        appBar: AppBar(
          title: Text(&#34;GDG Firebase chat&#34;),
        ),
      ),
    ),
  );
}
</code></pre>
<p>Let us now add assets to our project. We will first create a folder called <code>assets</code> and then create a sub folder within the <code>assets</code> folder, named <code>images</code>.</p>
<p>The end result should look like this:</p>
<p class="image-container"><img alt="folder_structure_02" src="img/967545df2c11749d.png"></p>
<p>You can <a href="https://github.com/martinloesethjensen/flutter-firebase/blob/master/gdg_flutter_firebase_chat/assets/images/user_placeholder.jpg" target="_blank">download the user_placeholder.jpg here</a> and then put it in your <code>images</code> folder.</p>
<p>In the <code>pubspec.yaml</code> we need to specify where the assets are located.</p>
<pre><code>flutter:
	...
  assets:
   - assets/images/
</code></pre>
<h2 is-upgraded>Add an App Drawer to Your App</h2>
<p>Now we will add an app drawer to the app.</p>
<p>We will create a method <code>_appDrawer()</code> that will return an <code>AppDrawer</code><a href="https://api.flutter.dev/flutter/widgets/Widget-class.html" target="_blank">Widget</a>.</p>
<pre><code>_appDrawer() {
  return Drawer(
    child: Column(
      children: &lt;Widget&gt;[
        DrawerHeader(
          child: Column(
            mainAxisAlignment: MainAxisAlignment.start,
            children: &lt;Widget&gt;[
              CircleAvatar(
                radius: 30.0,
                backgroundImage:
                    AssetImage(&#39;assets/images/user_placeholder.jpg&#39;), 
                backgroundColor: Colors.transparent,
              ),
              Text(
                &#39;Sumith Damodaran&#39;,
                style: TextStyle(color: Colors.black),
              ),
              Text(
                &#39;PM @ Sitecore&#39;,
                style: TextStyle(color: Colors.black),
              )
            ],
          ),
        ),
        Spacer(),
        ListTile(
          leading: Icon(Icons.home),
          title: Text(&#39;Home&#39;),
          onTap: () {},  // Handle tap of the app drawer item 
        ),
        Divider(),
        ListTile(
          leading: Icon(Icons.people),
          title: Text(&#39;Attendants&#39;),
          onTap: () {},  // Handle tap of the app drawer item 
        ),
        Spacer(flex: 8),
      ],
    ),
  );
}

</code></pre>
<p>We will add the <code>_appDrawer()</code> to the <code>drawer</code> field in our <code>Scaffold</code>(...):</p>
<pre><code>home: Scaffold(
        drawer: _appDrawer(),
        appBar: AppBar(
          title: Text(&#34;GDG Firebase chat&#34;),
        ),
      ),
</code></pre>
<p>Run the app and see that the changes should look like this:</p>
<p class="image-container"><img alt="app_drawer" src="img/6e0765d45eeec667.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Build the Chat Screen" duration="0">
        <p>Now we will create the chat screen. but first let us create another folder in the <code>lib</code> folder called <code>screens</code>. This folder will have files that specific to screens. In this case we will create a file called <code>chat_screen.dart</code>.</p>
<p>The <code>ChatScreen</code> class will be a <a href="https://api.flutter.dev/flutter/widgets/StatefulWidget-class.html" target="_blank">StatefulWidget</a> as we will be inputting text from the keyboard.</p>
<pre><code>import &#39;package:flutter/material.dart&#39;;

class ChatScreen extends StatefulWidget {
  @override
  _ChatScreenState createState() =&gt; _ChatScreenState();
}

class _ChatScreenState extends State&lt;ChatScreen&gt; {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text(&#34;Chats&#34;)),
    );
  }
}

</code></pre>
<p>In <code>main.dart</code> we will change the <code>home</code> parameter in <code>MaterialApp(...)</code>.</p>
<pre><code>home: ChatScreen(),
</code></pre>
<p>Now run and check that you see the chat screen.</p>
<p>We want our design to look more or less like the design.</p>
<p>Design:</p>
<p class="image-container"><img alt="chat_screen_design" src="img/260c3a870a633934.png"></p>
<p>We know the screen will have a text field so we will initialize a <code>TextEditingController</code> as a field in the class <code>_ChatScreenState</code>.</p>
<pre><code>bool _isComposing = false;  // Being used later to determine when TextEditingController is used to compose a message.
final TextEditingController _textMessageController = TextEditingController();
</code></pre>
<p>Then we will create a method <code>_buildMessageComposer()</code> where our input UI will be build.</p>
<pre><code>_buildMessageComposer() {
    return Container(
      padding: EdgeInsets.symmetric(horizontal: 8.0),
      height: 70.0,
      color: Colors.white,
      child: Row(
        children: &lt;Widget&gt;[
          RawMaterialButton(
            onPressed: () {},
            child: Icon(
              Icons.camera_alt,
              color: Colors.white,
              size: 25.0,
            ),
            shape: CircleBorder(),
            elevation: 2.0,
            fillColor: Theme.of(context).primaryColor,
            padding: EdgeInsets.all(15.0),
          ),
          Expanded(
            child: TextField(
		  				controller: _textMessageController,
              textCapitalization: TextCapitalization.sentences,
              onChanged: (value) {},
              decoration: InputDecoration(
                border: OutlineInputBorder(
                  borderRadius: BorderRadius.all(
                    Radius.circular(10.0),
                  ),
                ),
                hintText: &#39;Type your message...&#39;,
                filled: true,
                hintStyle: TextStyle(color: Colors.grey[400]),
              ),
            ),
          ),
          IconButton(
            icon: Icon(Icons.send),
            iconSize: 25.0,
            color: Theme.of(context).primaryColor,
            onPressed: () {},
          ),
        ],
      ),
    );
  }

</code></pre>
<p>We will then have the <code>Scaffoldbody</code> parameter to be the <code>_buildMessageComposer()</code>.</p>
<pre><code>body: _buildMessageComposer(),
</code></pre>
<p>Now run the app.</p>
<p>The screen should now look like this:</p>
<p class="image-container"><img alt="chat_screen_01" src="img/37f1435f081bcb9d.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Build Message UI" duration="0">
        <p>Before we start creating the UI for the messages, we should create some model classes, <code>user</code> and <code>message</code>.</p>
<p>Let&#39;s create a new folder in the <code>lib</code> folder, <code>models</code>. This will have all the model files we need.<br>Now create two files in the <code>models</code> folder: <code>user.dart</code> and <code>message.dart</code>.</p>
<p><code>user.dart</code>:</p>
<pre><code>class User {
  final int id;
  final String name, profileImageUrl, email, bio;

  User({
    this.id,
    this.name,
    this.profileImageUrl,
    this.email,
    this.bio,
  });
}

</code></pre>
<p><code>message.dart</code></p>
<pre><code>import &#39;package:gdg_flutter_firebase_chat/models/user.dart&#39;;

class Message {
  final User sender;
  final String
      time; // Would usually be type DateTime or Firebase Timestamp in production apps
  final String text;
  final bool isLiked;
  final bool unread;

  Message({
    this.sender,
    this.time,
    this.text,
    this.isLiked,
    this.unread,
  });
}

// EXAMPLE MESSAGES IN CHAT SCREEN
List&lt;Message&gt; messages = [
  Message(
    sender: martin,
    time: &#39;5:30 PM&#39;,
    text: &#39;Hey, how\&#39;s it going? What did you do today?&#39;,
    isLiked: true,
    unread: true,
  ),
  Message(
    sender: currentUser,
    time: &#39;4:30 PM&#39;,
    text: &#39;Just walked my doge. She was super duper cute. The best pupper!!&#39;,
    isLiked: false,
    unread: true,
  ),
  Message(
    sender: martin,
    time: &#39;3:45 PM&#39;,
    text: &#39;How\&#39;s the doggo?&#39;,
    isLiked: false,
    unread: true,
  ),
  Message(
    sender: martin,
    time: &#39;3:15 PM&#39;,
    text: &#39;All the food&#39;,
    isLiked: true,
    unread: true,
  ),
  Message(
    sender: currentUser,
    time: &#39;2:30 PM&#39;,
    text: &#39;Nice! What kind of food did you eat?&#39;,
    isLiked: false,
    unread: true,
  ),
  Message(
    sender: martin,
    time: &#39;2:00 PM&#39;,
    text: &#39;I ate so much food today.&#39;,
    isLiked: false,
    unread: true,
  ),
];

</code></pre>
<h2 is-upgraded>Messages UI in Chat Screen</h2>
<p>In our <code>chat_screen.dart</code> we create a new method <code>_buildMessage()</code> for our messages.</p>
<p><code>isMe</code> will be used later so when know how the styling of a message should be. With this we know what messages have been sent from who.</p>
<pre><code>_buildMessage(Message message, bool isMe) {
    final Widget msg = Padding(
      padding: EdgeInsets.all(8.0),
      child: Container(
        margin: isMe
            ? EdgeInsets.only(
                top: 8.0,
                bottom: 8.0,
                left: 80.0,
              )
            : EdgeInsets.only(
                top: 8.0,
                bottom: 8.0,
              ),
        padding: EdgeInsets.symmetric(horizontal: 25.0, vertical: 15.0),
        width: MediaQuery.of(context).size.width * 0.75,
        decoration: BoxDecoration(
          color: isMe
              ? AppConstants.hexToColor(AppConstants.APP_PRIMARY_COLOR_ACTION)
              : AppConstants.hexToColor(
                  AppConstants.APP_BACKGROUND_COLOR_WHITE),
          borderRadius: isMe
              ? BorderRadius.only(
                  topLeft: Radius.circular(15.0),
                  topRight: Radius.circular(15.0),
                  bottomLeft: Radius.circular(15.0),
                )
              : BorderRadius.only(
                  topLeft: Radius.circular(15.0),
                  topRight: Radius.circular(15.0),
                  bottomRight: Radius.circular(15.0),
                ),
        ),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: &lt;Widget&gt;[
            Text(
              message.text,
              style: TextStyle(
                color: isMe ? Colors.white60 : Colors.blueGrey,
                fontSize: 12.0,
                fontWeight: FontWeight.w600,
              ),
            ),
            SizedBox(height: 8.0),
            Row(
              mainAxisAlignment:
                  isMe ? MainAxisAlignment.end : MainAxisAlignment.start,
              children: &lt;Widget&gt;[
                Text(
                  message.time,
                  style: TextStyle(
                    color: isMe ? Colors.white60 : Colors.grey,
                    fontSize: 12.0,
                    fontWeight: FontWeight.w600,
                  ),
                ),
              ],
            ),
          ],
        ),
      ),
    );

    return Row(
      children: &lt;Widget&gt;[msg],
    );
  }
</code></pre>
<p>Remember to import the necessary packages, files and classes.</p>
<pre><code>import &#39;package:gdg_flutter_firebase_chat/helpers/app_constants.dart&#39;;
import &#39;package:gdg_flutter_firebase_chat/models/message.dart&#39;;
</code></pre>
<p>Let&#39;s create a list of messages as a field in the class <code>_ChatScreenState</code>.</p>
<pre><code>final List&lt;Message&gt; _messages = messages; // messages is the dummy data list in message.dart
</code></pre>
<p>Our <code>build()</code> method should now also iterate over the list of messages.</p>
<pre><code>@override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text(&#34;Chats&#34;)),
      body: ListView.builder(
        reverse: true,
        padding: EdgeInsets.only(top: 15.0),
        itemCount: _messages.length,
        itemBuilder: (BuildContext context, int index) {
          final Message message = _messages[index];
          final bool isMe = message.sender.id == currentUser.id;

          return _buildMessage(message, isMe);
        },
      ),
    );
  }
</code></pre>
<p>Run and see how it looks.<br>To make the list fit the screen with the text field where we compose messages, then we need to &#34;expand&#34; the view of the list.</p>
<pre><code>@override
  Widget build(BuildContext context) {
    return Container(
      color: Colors.white,
      child: SafeArea(
        top: false,
        child: Scaffold(
          appBar: AppBar(title: Text(&#34;Chats&#34;)),
          body: GestureDetector(
            onTap: () =&gt; FocusScope.of(context).unfocus(),  // Will hide the keyboard when the user touches the messages list view.
            child: Column(
              children: &lt;Widget&gt;[
                Expanded(  // Expand widget to fill the available space
                  child: Container(
                    child: ListView.builder(
                      reverse: true,
                      padding: EdgeInsets.only(top: 15.0),
                      itemCount: _messages.length,
                      itemBuilder: (BuildContext context, int index) {
                        final Message message = _messages[index];
                        final bool isMe = message.sender.id == currentUser.id;

                        return _buildMessage(message, isMe);
                      },
                    ),
                  ),
                ),
                _buildMessageComposer(),
              ],
            ),
          ),
        ),
      ),
    );
  }
</code></pre>
<h2 is-upgraded>Handle Composing messages</h2>
<p>We will create a method to handle when a message has been submitted. This method will be called: <code>_handleSubmitted</code> and it will take in a <code>String</code> as a parameter so it can create a new message and add it to our list <code>_messages</code>.</p>
<pre><code>void _handleSubmitted(String text) {
    _textMessageController.clear();

    setState(() {
      _isComposing = false;
    });
    Message message = Message(
      sender: currentUser,
      time: &#39;6:30 PM&#39;,
      text: text,
      isLiked: true,
      unread: true,
    );
    setState(() {
      _messages.insert(0, message);
    });
  }
</code></pre>
<p>Run the app and see that you can add new messages to the chat.</p>
<p class="image-container"><img alt="chat_screen" src="img/e8ec9f5ca16b89c4.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Create a Firebase Project" duration="0">
        <p>If you don&#39;t already have a Firebase account, then you can create one <a href="https://firebase.google.com/pricing/" target="_blank">here</a>. We will not be needing a paid plan for this codelab.</p>
<ol type="1">
<li>Sign in to <a href="https://console.firebase.google.com/" target="_blank">Firebase Console</a></li>
<li>Go ahead and click &#34;Add project&#34;</li>
</ol>
<p class="image-container"><img alt="Screenshot 2020-03-28 at 00.19.02" src="img/f24f114b7017ed5a.png"></p>
<ol type="1">
<li>Enable Google Analytics<br><img alt="firebase-step-2" src="img/4c00875caba0994.png"></li>
<li>You can then choose to either configure Google Analytics with existing Google Analytics account or create a new account name.</li>
</ol>
<p class="image-container"><img alt="firebase-step-3" src="img/4b0e225e063f2aa9.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Configure the Platforms" duration="0">
        <p>The next step for us to do is configure one or more apps to our Firebase project. We will do this by registering the app&#39;s bundle ID with Firebase and then generate config files to put in the our project.</p>
<p class="image-container"><img alt="configure-platforms" src="img/c1c1ae5c346a3f41.png"></p>
<h2 is-upgraded>Android Configuration</h2>
<p>You can find a detailed description on how to <a href="https://firebase.google.com/docs/flutter/setup?platform=android" target="_blank">add Firebase to your Flutter app with Android configuration</a>.</p>
<h2 is-upgraded>iOS Configuration</h2>
<p>You can find a detailed description on how to <a href="https://firebase.google.com/docs/flutter/setup?platform=ios" target="_blank">add Firebase to your Flutter app with iOS configuration</a>.</p>


      </google-codelab-step>
    
      <google-codelab-step label="Firebase Starting Point" duration="0">
        <p>Follow along by cloning or downloading <a href="https://github.com/sumithpdd/gdg_flutter_firebase_chat/tree/FirebaseInitial" target="_blank">this repo</a>.</p>
<p>You can use <code>git</code> by getting the right branch <code>FirebaseInitial</code></p>
<pre><code>git clone https://github.com/sumithpdd/gdg_flutter_firebase_chat.git -b FirebaseInitial
</code></pre>
<p>Navigate to the newly cloned folder.</p>
<pre><code>cd gdg_flutter_firebase_chat
</code></pre>
<p>Then run the <code>flutter pub get</code> command to get all dependencies set up for the project.</p>
<pre><code>flutter pub get
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Task: Authentication &amp; Login" duration="0">
        <p>In the <code>lib</code> folder create another folder <code>services</code>. In here we will create a dart file called <code>auth_service.dart</code>.</p>
<p>We will make a service class that handle auth, which in this case is login, logout, and signup.</p>
<pre><code>class AuthService {
  final FirebaseAuth _firebaseAuth = FirebaseAuth.instance;
   Stream&lt;FirebaseUser&gt; get user =&gt; _firebaseAuth.onAuthStateChanged;
 
  Future&lt;void&gt; signup(String name, String email, String password) async {
    try {
      AuthResult authResult = await _firebaseAuth.createUserWithEmailAndPassword(
          email: email, password: password);
 
    } on PlatformException catch (error) {
      throw (error);
    }
  }
 
  Future&lt;void&gt; login(String email, String password) async {
    try {
      await _firebaseAuth.signInWithEmailAndPassword(
          email: email, password: password);
    } on PlatformException catch (error) {
      throw (error);
    }
  }
 
  Future&lt;void&gt; logout() {
    Future.wait([_firebaseAuth.signOut()]);
  }
}

</code></pre>
<p>We would need to get a hold of the Firebase instance, so for now let us put some of our collections, storage referrences and instances in the <code>constants.dart</code> file in the <code>helpers</code> folder</p>
<pre><code>import &#39;package:cloud_firestore/cloud_firestore.dart&#39;;
import &#39;package:firebase_storage/firebase_storage.dart&#39;;

final Firestore _db = Firestore.instance;
final usersRef = _db.collection(&#39;users&#39;);
final chatsRef = _db.collection(&#39;chats&#39;);
 
final FirebaseStorage _storage = FirebaseStorage.instance;
final storageRef =_storage.ref();
</code></pre>
<p>Then we need to update the <code>signup</code> method so the file should look like this.</p>
<pre><code>import &#39;package:firebase_auth/firebase_auth.dart&#39;;
import &#39;package:firebase_messaging/firebase_messaging.dart&#39;;
import &#39;package:flutter/services.dart&#39;;
import &#39;package:gdg_flutter_firebase_chat/helpers/constants.dart&#39;; 

class AuthService {
  final FirebaseAuth _firebaseAuth = FirebaseAuth.instance;
  final FirebaseMessaging _firebaseMessaging = FirebaseMessaging();
  Stream&lt;FirebaseUser&gt; get user =&gt; _firebaseAuth.onAuthStateChanged;

  Future&lt;void&gt; signup(String name, String email, String password) async {
    try {
      AuthResult authResult = await _firebaseAuth.createUserWithEmailAndPassword(
          email: email, password: password);

      if (authResult.user != null) {
        String token = await _firebaseMessaging.getToken();
        usersRef.document(authResult.user.uid).setData({
          &#39;name&#39;: name,
          &#39;email&#39;: email, 
          &#39;profileImageUrl&#39;: &#39;&#39;,
          &#39;bio&#39;: &#39;&#39;,
          &#39;token&#39;: token,
        });
        print(&#39;Signup complete&#39;);
      }
    } on PlatformException catch (error) {
      throw (error);
    }
  }

  Future&lt;void&gt; login(String email, String password) async {
    try {
      await _firebaseAuth.signInWithEmailAndPassword(
          email: email, password: password);
          print(&#39;login complete&#39;);
    } on PlatformException catch (error) {
      throw (error);
    }
  }

  Future&lt;void&gt; logout() {
    Future.wait([_firebaseAuth.signOut()]);
  }
}
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Task: Modify User" duration="0">
        <p>Now let us modify the <code>User</code> class.</p>
<pre><code>class User {
  final String id;
  final String name;
  final String profileImageUrl, email, bio, token;
  
  // {} named parameters
  User(
     {this.id,
      this.name,
      this.profileImageUrl,
      this.email,
      this.bio,
      this.token});
 
  factory User.fromDoc(DocumentSnapshot doc) {
    return User(
        id: doc.documentID,
        name: doc[&#39;name&#39;],
        profileImageUrl: doc[&#39;profileImageUrl&#39;],
        email: doc[&#39;email&#39;],
        bio: doc[&#39;bio&#39;],
        token: doc[&#39;token&#39;]);
  }
}

</code></pre>
<h2 is-upgraded>Check Firebase Security Rules</h2>
<p>For our app we won&#39;t have it in production so we would either put the firestore rule set in &#34;Test Mode&#34; meaning read and write access for anybody in 30 days. Or just have it all enabled for all users.</p>
<pre><code>// Allow read/write access to all users under any conditions
// Warning: **NEVER** use this rule set in production; it allows
// anyone to overwrite your entire database.
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if true;
    }
  }
}
</code></pre>
<aside class="warning"><p>Allow read/write access to all users under any conditions.<br>Warning: <strong>NEVER</strong> use this rule set in production; it allows anyone to overwrite your entire database.</p>
</aside>
<aside class="special"><p>You can read more on Firebase security rules <a href="https://firebase.google.com/docs/firestore/security/get-started" target="_blank">here</a>.</p>
</aside>
<h2 is-upgraded>Update Messages</h2>
<p>As we have changed the <code>User</code> constructor parameters we need to fix this:</p>
<pre><code>// YOU - current user
final User currentUser = User(
 id: &#39;0&#39;,
 name: &#39;Current User&#39;,
 profileImageUrl: &#39;assets/images/greg.jpg&#39;,
);
final User sumith = User(
 id: &#39;1&#39;,
 name: &#39;sumith&#39;,
 profileImageUrl: &#39;assets/images/greg.jpg&#39;,
);
final User martin = User(
 id: &#39;2&#39;,
 name: &#39;martin&#39;,
 profileImageUrl: &#39;assets/images/james.jpg&#39;,
);
final User laura = User(
 id: &#39;3&#39;,
 name: &#39;laura&#39;,
 profileImageUrl: &#39;assets/images/john.jpg&#39;,
);
final User bilal = User(
 id: &#39;4&#39;,
 name: &#39;bilal&#39;,
 profileImageUrl: &#39;assets/images/olivia.jpg&#39;,
);
final User sam = User(
 id: &#39;5&#39;,
 name: &#39;Sam&#39;,
 profileImageUrl: &#39;assets/images/sam.jpg&#39;,
);
final User sophia = User(
 id: &#39;6&#39;,
 name: &#39;Sophia&#39;,
 profileImageUrl: &#39;assets/images/sophia.jpg&#39;,
);
final User steven = User(
 id: &#39;7&#39;,
 name: &#39;Steven&#39;,
 profileImageUrl: &#39;assets/images/steven.jpg&#39;,
);
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Task: Login &amp; Signup Screen" duration="0">
        <p>To check if authentication is working, We will create a new screen for Login and Signup.</p>
<p>Create a <code>login_screen.dart</code> in the <code>screens</code> folder.</p>
<pre><code>import &#39;package:flutter/material.dart&#39;;
import &#39;package:flutter/services.dart&#39;;
import &#39;package:gdg_flutter_firebase_chat/helpers/app_constants.dart&#39;;
import &#39;package:gdg_flutter_firebase_chat/services/auth_service.dart&#39;;
 
class LoginScreen extends StatefulWidget {
 @override
 _LoginScreenState createState() =&gt; _LoginScreenState();
}
 
class _LoginScreenState extends State&lt;LoginScreen&gt; {
 final _loginFormKey = GlobalKey&lt;FormState&gt;();
 final _signupFormKey = GlobalKey&lt;FormState&gt;();
 String _name, _email, _password;
 int _selectedIndex = 0;
 
 _buildLoginForm() {
   return Form(
     key: _loginFormKey,
     child: Column(children: &lt;Widget&gt;[
       _buildEmailTF(),
       _buildPasswordTF(),
     ]),
   );
 }
 
 _buildSignupForm() {
   return Form(
     key: _signupFormKey,
     child: Column(children: &lt;Widget&gt;[
       _buildNameTF(),
       _buildEmailTF(),
       _buildPasswordTF(),
     ]),
   );
 }
 
 _buildNameTF() {
   return Padding(
     padding: const EdgeInsets.symmetric(horizontal: 30.0, vertical: 10.0),
     child: TextFormField(
       decoration: const InputDecoration(labelText: &#39;Name&#39;),
       validator: (input) =&gt;
           input.trim().isEmpty ? &#39;Please enter a vaild name&#39; : null,
       onSaved: (input) =&gt; _name = input.trim(),
     ),
   );
 }
 
 _buildEmailTF() {
   return Padding(
     padding: const EdgeInsets.symmetric(horizontal: 30.0, vertical: 10.0),
     child: TextFormField(
       decoration: const InputDecoration(labelText: &#39;Email&#39;),
       validator: (input) =&gt;
           !input.contains(&#39;@&#39;) ? &#39;Please enter a vaild email&#39; : null,
       onSaved: (input) =&gt; _email = input,
     ),
   );
 }
 
 _buildPasswordTF() {
   return Padding(
     padding: const EdgeInsets.symmetric(horizontal: 30.0, vertical: 10.0),
     child: TextFormField(
       decoration: const InputDecoration(labelText: &#39;Password&#39;),
       validator: (input) =&gt;
           input.length &lt; 6 ? &#39;Password must be atleast 6 characters&#39; : null,
       onSaved: (input) =&gt; _password = input,
       obscureText: true,
     ),
   );
 }
 
 _submit() async {
   try {
     if (_selectedIndex == 0 &amp;&amp; _loginFormKey.currentState.validate()) {
       _loginFormKey.currentState.save();
       await authservice.login(_email, _password);
     } else if (_selectedIndex == 1 &amp;&amp;
         _signupFormKey.currentState.validate()) {
       _signupFormKey.currentState.save();
       await authservice.signup(_name, _email, _password);
     }
   } on PlatformException catch (error) {
     _showErrorDialog(error.message);
   }
 }
 
 _showErrorDialog(String errorMessage) {
   showDialog(
     context: context,
     builder: (_) {
       return AlertDialog(
         title: Text(&#39;Error&#39;),
         content: Text(errorMessage),
         actions: &lt;Widget&gt;[
           FlatButton(
               onPressed: () =&gt; Navigator.pop(context), child: Text(&#39;OK&#39;))
         ],
       );
     },
   );
 }
 final AuthService authservice =  AuthService();
 @override
 Widget build(BuildContext context) {
   return Scaffold(
     body: Center(
       child: Column(
         mainAxisAlignment: MainAxisAlignment.center,
         children: &lt;Widget&gt;[
           Text(&#39;Welcome!&#39;,
               style: TextStyle(fontSize: 30.0, fontWeight: FontWeight.w600)),
           const SizedBox(height: 10.0),
           Row(
             mainAxisAlignment: MainAxisAlignment.spaceEvenly,
             children: &lt;Widget&gt;[
               Container(
                 width: 150.0,
                 child: FlatButton(
                   shape: RoundedRectangleBorder(
                     borderRadius: BorderRadius.circular(10.0),
                   ),
                   color: _selectedIndex == 0 ? AppConstants.hexToColor(AppConstants.APP_PRIMARY_COLOR) : Colors.grey[300],
                   child: Text(
                     &#39;Login&#39;,
                     style: TextStyle(
                         fontSize: 20.0,
                         color:
                             _selectedIndex == 0 ? Colors.white : AppConstants.hexToColor(AppConstants.APP_PRIMARY_COLOR)),
                   ),
                   onPressed: () =&gt; setState(() =&gt; _selectedIndex = 0),
                 ),
               ),
               Container(
                 width: 150.0,
                 child: FlatButton(
                   shape: RoundedRectangleBorder(
                     borderRadius: BorderRadius.circular(10.0),
                   ),
                   color: _selectedIndex == 1 ? AppConstants.hexToColor(AppConstants.APP_PRIMARY_COLOR) : Colors.grey[300],
                   child: Text(
                     &#39;Sign Up&#39;,
                     style: TextStyle(
                         fontSize: 20.0,
                         color:
                             _selectedIndex == 1 ? Colors.white : AppConstants.hexToColor(AppConstants.APP_PRIMARY_COLOR)),
                   ),
                   onPressed: () =&gt; setState(() =&gt; _selectedIndex = 1),
                 ),
               )
             ],
           ),
           _selectedIndex == 0 ? _buildLoginForm() : _buildSignupForm(),
           const SizedBox(height: 20.0),
           Container(
               width: 180,
               child: FlatButton(
                 shape: RoundedRectangleBorder(
                     borderRadius: BorderRadius.circular(10.0)),
                 color: AppConstants.hexToColor(AppConstants.APP_PRIMARY_COLOR),
                 onPressed: _submit,
                 child: Text(
                   &#39;Submit&#39;,
                   style: TextStyle(
                     color: Colors.white,
                     fontSize: 20.0,
                   ),
                 ),
               ))
         ],
       ),
     ),
   );
 }
}

</code></pre>
<aside class="special"><p>Rember to update the <code>home</code> parameter in the <code>main.dart</code> file to: <code>home: LoginScreen(),</code></p>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="Task: Attendees Screen" duration="0">
        <p>After login or signup we need to redirect to the screen with attendees.</p>
<p>So let us create a new file in the <code>screens</code> folder called <code>attendees_screen.dart</code></p>
<pre><code>import &#39;package:flutter/material.dart&#39;;
import &#39;package:gdg_flutter_firebase_chat/models/user.dart&#39;;
import &#39;package:gdg_flutter_firebase_chat/models/user_data.dart&#39;;
import &#39;package:gdg_flutter_firebase_chat/services/auth_service.dart&#39;;
import &#39;package:gdg_flutter_firebase_chat/services/database_service.dart&#39;;
import &#39;package:gdg_flutter_firebase_chat/widgets/all_attendees_widget.dart&#39;;
import &#39;package:provider/provider.dart&#39;;
 
class AttendeesScreen extends StatefulWidget {
  static final String id =&#39;attendees_screen&#39;;
 
 @override
 _AttendeesScreenState createState() =&gt; _AttendeesScreenState();
}
 
class _AttendeesScreenState extends State&lt;AttendeesScreen&gt; {
 List&lt;User&gt; _users = [];
 @override
 void initState() {
   super.initState();
   _setupAttendees();
 }
 
 _setupAttendees() async {
   String currentUserId =Provider.of&lt;UserData&gt;(context, listen: false).currentUserId;
   List&lt;User&gt; users = await Provider.of&lt;DataBaseService&gt;(context, listen: false)
                     .getAllUsers(currentUserId);
   if (mounted) {
     setState(() {
       _users = users;
     });
   }
 }
 @override
 Widget build(BuildContext context) {
   
   return Scaffold(
     backgroundColor: Theme.of(context).primaryColor,
     appBar: AppBar(
       leading: IconButton(
         icon: Icon(Icons.menu),
         iconSize: 30.0,
         color: Colors.white,
         onPressed: () {},
       ),
       title: Text(
         &#39;Attendees&#39;,
         style: TextStyle(
           fontSize: 28.0,
           fontWeight: FontWeight.bold,
         ),
       ),
       elevation: 0.0,
       actions: &lt;Widget&gt;[
         IconButton(
           icon: Icon(Icons.exit_to_app),
           onPressed: Provider.of&lt;AuthService&gt;(context, listen: false).logout,
         ),
       ],
     ),
     body: Column(
       children: &lt;Widget&gt;[
         Expanded(
           child: Container(
             decoration: BoxDecoration(
               color: Theme.of(context).accentColor,
               borderRadius: BorderRadius.only(
                 topLeft: Radius.circular(30.0),
                 topRight: Radius.circular(30.0),
               ),
             ),
             child: Column(
               children: &lt;Widget&gt;[
                  AllAttendees(users:_users),
               ],
             ),
           ),
         ),
       ],
     ),
   );
 }
}

</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Task: Model to Store Current User Data" duration="0">
        <p>To store current user data we will create a model file <code>user_data.dart</code> under <code>models</code></p>
<pre><code>import &#39;package:flutter/material.dart&#39;;
 
class UserData extends ChangeNotifier {
  String currentUserId;
}

</code></pre>
<p>We use this class to pass data between screens, for that we will use the <a href="https://pub.dev/packages/provider" target="_blank">provider package</a>. A mixture between dependency injection (DI) and state management, built with widgets for widgets.</p>
<p>Add this to your package&#39;s <code>pubspec.yaml</code> file:</p>
<pre><code>dependencies:
  provider: ^4.0.5
</code></pre>
<p>Remember to get the dependencies by running this command</p>
<pre><code>flutter pub get
</code></pre>
<aside class="special"><p>You can find the latest version <a href="https://pub.dev/packages/provider#-installing-tab-" target="_blank">here</a>.</p>
</aside>
<p>The attendees are all the users that have registered. We update our database service and will create a new function to get all users.</p>
<p>Firstly create a new file for the <code>services</code> folder called <code>database_service.dart</code>.</p>
<pre><code>import &#39;package:cloud_firestore/cloud_firestore.dart&#39;;
import &#39;package:gdg_flutter_firebase_chat/helpers/constants.dart&#39;;
import &#39;package:gdg_flutter_firebase_chat/models/user.dart&#39;;
 
class DataBaseService {
 Future&lt;User&gt; getUser(String userId) async {
   DocumentSnapshot userDoc = await usersRef.document(userId).get();
   return User.fromDoc(userDoc);
 }
 
 Future&lt;List&lt;User&gt;&gt; getAllUsers(String currentUserId) async {
   QuerySnapshot userSnapshot = await usersRef.getDocuments();
   List&lt;User&gt; users = [];
   userSnapshot.documents.forEach((doc) {
     User user = User.fromDoc(doc);
     if (user.id != currentUserId) users.add(user);
   });
   return users;
 }
}

</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Introduction to Widget - Separation of Concern" duration="0">
        <p>Create a <code>widgets</code> folder in the <code>lib</code>folder, afterwards we will create a file in the newly created folder. Name the file: <code>all_attendees_widget.dart</code></p>
<pre><code>import &#39;package:flutter/material.dart&#39;;
import &#39;package:gdg_flutter_firebase_chat/models/user.dart&#39;;
import &#39;package:gdg_flutter_firebase_chat/screens/chat_screen.dart&#39;;
import &#39;package:cached_network_image/cached_network_image.dart&#39;;
 
class AllAttendees extends StatelessWidget {
 final List&lt;User&gt; users;
 
 const AllAttendees({this.users});
 @override
 Widget build(BuildContext context) {
   return Expanded(
     child: Container(
       decoration: BoxDecoration(
         color: Colors.white,
       
       ),
       child: Padding(
         padding: const EdgeInsets.all(8.0),
         child: ListView.builder(
           itemCount: users.length,
           itemBuilder: (BuildContext context, int index) {
             final User user = users[index];
             return GestureDetector(
               onTap: () =&gt; Navigator.push(
                 context,
                 MaterialPageRoute(
                   builder: (_) =&gt; ChatScreen(
                       // user: chat.sender,
                       ),
                 ),
               ),
               child: Container(
                 margin: EdgeInsets.only(top: 5.0, bottom: 5.0, right: 5.0),
                 padding:
                     EdgeInsets.symmetric(horizontal: 10.0, vertical: 10.0),
                 decoration: BoxDecoration(
                   color: Color(0xFFFFEFEE),
                   borderRadius: BorderRadius.all( Radius.circular(20.0)
                   ),
                 ),
                 child: Row(
                   mainAxisAlignment: MainAxisAlignment.spaceBetween,
                   children: &lt;Widget&gt;[
                     Row(
                       children: &lt;Widget&gt;[
                         CircleAvatar(
                           radius: 35.0,
                           backgroundImage: user.profileImageUrl.isEmpty
                               ? AssetImage(&#39;assets/images/user_placeholder.jpg&#39;)
                               : CachedNetworkImageProvider(user.profileImageUrl),
                         ),
                         SizedBox(width: 10.0),
                         Column(
                           crossAxisAlignment: CrossAxisAlignment.start,
                           children: &lt;Widget&gt;[
                             Text(
                               user.name,
                               style: TextStyle(
                                 color: Colors.grey,
                                 fontSize: 15.0,
                                 fontWeight: FontWeight.bold,
                               ),
                             ),
                             SizedBox(height: 5.0),
                             Text(
                               user.bio,
                               style: TextStyle(
                                 color: Colors.grey,
                                 fontSize: 15.0,
                               ),
                             ),
                           ],
                         ),
                       ],
                     ),
                   ],
                 ),
               ),
             );
           },
         ),
       ),
     ),
   );
 }
}

</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Task: User Profile Images" duration="0">
        <p>Profile images will come from the network, We will use the Flutter library to load and cache network images. We will be using <a href="https://pub.dev/packages/cached_network_image" target="_blank">cached_network_image package</a>.</p>
<p>Add this to your package&#39;s <code>pubspec.yaml</code> file:</p>
<pre><code>dependencies:
  cached_network_image: ^2.1.0+1
</code></pre>
<p>Remember to get the dependencies by running this command</p>
<pre><code>flutter pub get
</code></pre>
<aside class="special"><p>You can find the latest version <a href="https://pub.dev/packages/cached_network_image#-installing-tab-" target="_blank">here</a>.</p>
</aside>
<p>We got all our references now we need to navigate from main to attendees screen if we are logged in. Quickly update the login screen and give it an id. This will be used for <strong>routes</strong> when navigating between screens.</p>
<pre><code>class LoginScreen extends StatefulWidget {
   static final String id =&#39;login_screen&#39;;
   ...
</code></pre>
<aside class="special"><p>Read more about <a href="https://flutter.dev/docs/cookbook/navigation/named-routes" target="_blank">named routes</a>.</p>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="Task: Refactor main.dart" duration="0">
        <p>We will refactor main.dart, and check if the user is logged in, we will create a new class that extends StatelessWidget.</p>
<pre><code>class MyApp extends StatelessWidget {
 Widget _getScreenId() {
   return StreamBuilder&lt;FirebaseUser&gt;(
     stream: FirebaseAuth.instance.onAuthStateChanged,
     builder: (BuildContext context, snapshot) {
       if (snapshot.hasData) {
         Provider.of&lt;UserData&gt;(context).currentUserId = snapshot.data.uid;
         return AttendeesScreen();
       } else {
         return LoginScreen();
       }
     },
   );
 }
 
 // This widget is the root of your application.
 @override
 Widget build(BuildContext context) {
   return MaterialApp(
     title: &#34;GDG Firebase chat&#34;,
     debugShowCheckedModeBanner: false,
     theme: ThemeData(
       primaryColor: AppConstants.hexToColor(AppConstants.APP_PRIMARY_COLOR),
       backgroundColor:
           AppConstants.hexToColor(AppConstants.APP_BACKGROUND_COLOR),
       primaryColorLight:
           AppConstants.hexToColor(AppConstants.APP_PRIMARY_COLOR_LIGHT),
       accentColor: Colors.black,
       accentIconTheme: IconThemeData(color: Colors.black),
       dividerColor: Colors.black12,
       textTheme: TextTheme(
         caption: TextStyle(color: Colors.white),
       ),
     ),
     home: _getScreenId(),
     routes: {
       LoginScreen.id: (context) =&gt; LoginScreen(),
       AttendeesScreen.id: (context) =&gt; AttendeesScreen(),
     },
   );
 }
}
</code></pre>
<p>Then let us modify <code>runApp()</code> to call <code>MyApp()</code>, we will also define all the <strong>providers</strong> for the app.</p>
<pre><code>runApp(MultiProvider(providers: [
   ChangeNotifierProvider(
     create: (_) =&gt; UserData(),
   ),
   Provider&lt;AuthService&gt;(
     create: (_) =&gt; AuthService(),
   ),
   Provider&lt;DataBaseService&gt;(
     create: (_) =&gt; DataBaseService(),
   ),
 ], child: MyApp()));
}
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Firebase Storage" duration="0">
        <p>Here we will look at <a href="https://firebase.google.com/docs/storage" target="_blank">Firebase Storage</a>, we have images for the attendees profileImages we can store in firebase storage. For that we will create a &#34;edit profile&#34; screen.</p>
<h2 is-upgraded>Edit Profile</h2>
<p>Let us refactor some code by moving the <strong>AppDrawer</strong> into its own widget so it can be reused throughout the project.</p>
<p>Create a new file in the <code>widgets</code> folder called <code>app_drawer_widget.dart</code></p>
<pre><code>import &#39;package:cached_network_image/cached_network_image.dart&#39;;
import &#39;package:flutter/material.dart&#39;;
import &#39;package:gdg_flutter_firebase_chat/helpers/app_constants.dart&#39;;
import &#39;package:gdg_flutter_firebase_chat/models/user.dart&#39;;
import &#39;package:gdg_flutter_firebase_chat/models/user_data.dart&#39;;
import &#39;package:gdg_flutter_firebase_chat/screens/edit_profile_screen.dart&#39;;
import &#39;package:gdg_flutter_firebase_chat/services/database_service.dart&#39;;
import &#39;package:provider/provider.dart&#39;;
 
class AppDrawer extends StatefulWidget {
 @override
 _AppDrawerState createState() =&gt; _AppDrawerState();
}
 
class _AppDrawerState extends State&lt;AppDrawer&gt; {
 _buildActivity(BuildContext context, String userId) {
   return FutureBuilder(
       future: Provider.of&lt;DataBaseService&gt;(context, listen: false)
           .getUser(userId),
       builder: (BuildContext context, AsyncSnapshot snapshot) {
         if (!snapshot.hasData) {
           return SizedBox.shrink();
         }
         User user = snapshot.data;
         return DrawerHeader(
           child: Column(
             mainAxisAlignment: MainAxisAlignment.start,
            
             children: &lt;Widget&gt;[
               CircleAvatar(
                 radius: 20.0,
                 backgroundImage: user.profileImageUrl.isEmpty
                     ? AssetImage(&#39;assets/images/user_placeholder.jpg&#39;)
                     : CachedNetworkImageProvider(user.profileImageUrl),
                 backgroundColor: Colors.transparent,
               ),
               Text(
                 user.name,
                 style: TextStyle(color: Colors.black),
               ),
               Text(
                 user.bio,
                 style: TextStyle(color: Colors.black),
               ),
               IconButton(
                 icon: Icon(Icons.edit),
                 tooltip: &#39;Edit Profile&#39;,
                 onPressed: () =&gt; Navigator.push(
                   context,
                   MaterialPageRoute(
                     builder: (_) =&gt; EditProfileScreen(
                       user: user,
                     ),
                   ),
                 ),
                 color:
                     AppConstants.hexToColor(AppConstants.APP_PRIMARY_COLOR),
               ),
             ],
           ),
         );
       });
 }
 
 @override
 Widget build(BuildContext context) {
   String currentUserId = Provider.of&lt;UserData&gt;(context).currentUserId;
   return Drawer(
     child: Column(
       children: &lt;Widget&gt;[
         currentUserId.isNotEmpty
             ? _buildActivity(context, currentUserId)
             : SizedBox.shrink(),
         Spacer(),
         ListTile(
           leading: Icon(Icons.home),
           title: Text(&#39;Home&#39;),
           onTap: () {},
         ),
         Divider(),
         ListTile(
           leading: Icon(Icons.people),
           title: Text(&#39;Attendants&#39;),
           onTap: () {},
         ),
         Spacer(flex: 8),
       ],
     ),
   );
 }
}
</code></pre>
<h2 is-upgraded>Update Usages of the AppDrawer</h2>
<p>Update <code>attendees_screen.dart</code> to use the newly made widget.</p>
<pre><code>drawer: AppDrawer(),
</code></pre>
<p>While we are at it let us delete this.</p>
<pre><code> leading: IconButton(
            icon: Icon(Icons.menu),
            iconSize: 30.0,
            color: Colors.white,
            onPressed: () {},
          ),
</code></pre>
<h2 is-upgraded>Edit Profile Screen</h2>
<p>Create a new screen <code>edit_profile_screen.dart</code> in the <code>screens</code> folder.</p>
<pre><code>import &#39;dart:io&#39;;
 
import &#39;package:cached_network_image/cached_network_image.dart&#39;;
import &#39;package:flutter/material.dart&#39;;
import &#39;package:gdg_flutter_firebase_chat/helpers/app_constants.dart&#39;;
import &#39;package:gdg_flutter_firebase_chat/models/user.dart&#39;;
import &#39;package:gdg_flutter_firebase_chat/services/storage_service.dart&#39;;
import &#39;package:gdg_flutter_firebase_chat/services/database_service.dart&#39;;
import &#39;package:image_picker/image_picker.dart&#39;;
 
class EditProfileScreen extends StatefulWidget {
   static final String id = &#39;edit_profile_screen&#39;;
 
 final User user;
 EditProfileScreen({this.user});
 @override
 _EditProfileScreenState createState() =&gt; _EditProfileScreenState();
}
 
class _EditProfileScreenState extends State&lt;EditProfileScreen&gt; {
 final _formKey = GlobalKey&lt;FormState&gt;();
 File _profileImage;
 String _name = &#39;&#39;;
 String _bio = &#39;&#39;;
 bool _isLoading = false;
 @override
 void initState() {
   super.initState();
   _name = widget.user.name;
   _bio = widget.user.bio;
 }
 
 _handleImageFromGallery() async {
   File imageFile = await ImagePicker.pickImage(source: ImageSource.gallery);
   if (imageFile != null) {
     setState(() {
       _profileImage = imageFile;
     });
   }
 }
 
 _displayProfileImage() {
   // No new profile image
   if (_profileImage == null) {
     // No existing profile image
     if (widget.user.profileImageUrl.isEmpty) {
       // Display placeholder
       return AssetImage(&#39;assets/images/user_placeholder.jpg&#39;);
     } else {
       // User profile image exists
       return CachedNetworkImageProvider(widget.user.profileImageUrl);
     }
   } else {
     // New profile image
     return FileImage(_profileImage);
   }
 }
 
 _submit() async {
   if (_formKey.currentState.validate() &amp;&amp; !_isLoading) {
     _formKey.currentState.save();
 
     setState(() {
       _isLoading = true;
     });
 
     // Update user in database
     String _profileImageUrl = &#39;&#39;;
 
     if (_profileImage == null) {
       _profileImageUrl = widget.user.profileImageUrl;
     } else {
       _profileImageUrl = await StorageService.uploadUserProfileImage(
         widget.user.profileImageUrl,
         _profileImage,
       );
     }
 
     User user = User(
       id: widget.user.id,
       name: _name,
       profileImageUrl: _profileImageUrl,
       bio: _bio,
     );
     // Database update
     DataBaseService.updateUser(user);
 
     Navigator.pop(context);
   }
 }
 
 @override
 Widget build(BuildContext context) {
   return Scaffold(
     backgroundColor: Colors.white,
     appBar: AppBar(
       backgroundColor: Colors.white,
       title: Text(
         &#39;Edit Profile&#39;,
         style: TextStyle(color: Colors.black),
       ),
     ),
     body: GestureDetector(
       onTap: () =&gt; FocusScope.of(context).unfocus(),
       child: ListView(
         children: &lt;Widget&gt;[
           _isLoading
               ? LinearProgressIndicator(
                   backgroundColor: AppConstants.hexToColor(AppConstants.APP_PRIMARY_COLOR),
                   valueColor: AlwaysStoppedAnimation(AppConstants.hexToColor(AppConstants.APP_PRIMARY_COLOR)),
                 )
               : SizedBox.shrink(),
           Padding(
             padding: const EdgeInsets.all(30.0),
             child: Form(
               key: _formKey,
               child: Column(
                 children: &lt;Widget&gt;[
                   CircleAvatar(
                     radius: 60.0,
                     backgroundColor: Colors.grey,
                     backgroundImage: _displayProfileImage(),
                   ),
                   FlatButton(
                     onPressed: _handleImageFromGallery,
                     child: Text(
                       &#39;Change Profile Image&#39;,
                       style: TextStyle(
                           color: Theme.of(context).accentColor,
                           fontSize: 16.0),
                     ),
                   ),
                   TextFormField(
                     initialValue: _name,
                     style: TextStyle(fontSize: 18.0),
                     decoration: InputDecoration(
                       icon: Icon(
                         Icons.person,
                         size: 30.0,
                       ),
                       labelText: &#39;Name&#39;,
                     ),
                     validator: (input) =&gt; input.trim().length &lt; 1
                         ? &#39;Please enter a valid name&#39;
                         : null,
                     onSaved: (input) =&gt; _name = input,
                   ),
                   TextFormField(
                     initialValue: _bio,
                     style: TextStyle(fontSize: 18.0),
                     decoration: InputDecoration(
                       icon: Icon(
                         Icons.book,
                         size: 30.0,
                       ),
                       labelText: &#39;Bio&#39;,
                     ),
                     validator: (input) =&gt; input.trim().length &gt; 150
                         ? &#39;Please enter a bio less than 150 characters&#39;
                         : null,
                     onSaved: (input) =&gt; _bio = input,
                   ),
                   Container(
                     margin: EdgeInsets.all(40.0),
                     height: 40.0,
                     width: 250.0,
                     child: FlatButton(
                       onPressed: _submit,
                       color: AppConstants.hexToColor(AppConstants.APP_PRIMARY_COLOR),
                       textColor: Colors.white,
                       child: Text(
                         &#39;Save Profile&#39;,
                         style: TextStyle(fontSize: 18.0),
                       ),
                     ),
                   ),
                 ],
               ),
             ),
           ),
         ],
       ),
     ),
   );
 }
}
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Task: Storing Profile Image" duration="0">
        <p>We will need to update the <code>database_service.dart</code> file and add a new function.</p>
<pre><code>static void updateUser(User user) {
   usersRef.document(user.id).updateData({
     &#39;name&#39;: user.name,
     &#39;profileImageUrl&#39;: user.profileImageUrl,
     &#39;bio&#39;: user.bio,
   });
}
</code></pre>
<p>For storing a profile image we will need a new service, <code>storage_service.dart</code> in the <code>service</code> folder. Here we will create functions to handle the upload of user profile image.</p>
<pre><code>import &#39;dart:io&#39;;
 
import &#39;package:firebase_storage/firebase_storage.dart&#39;;
import &#39;package:flutter_image_compress/flutter_image_compress.dart&#39;;
import &#39;package:gdg_flutter_firebase_chat/helpers/constants.dart&#39;;
import &#39;package:path_provider/path_provider.dart&#39;;
import &#39;package:uuid/uuid.dart&#39;;
 
class StorageService {
 static Future&lt;String&gt; uploadUserProfileImage(
     String url, File imageFile) async {
   String photoId = Uuid().v4();
   File image = await compressImage(photoId, imageFile);
 
   if (url.isNotEmpty) {
     // Updating user profile image
     RegExp exp = RegExp(r&#39;userProfile_(.*).jpg&#39;);
     photoId = exp.firstMatch(url)[1];
   }
 
   StorageUploadTask uploadTask = storageRef
       .child(&#39;images/users/userProfile_$photoId.jpg&#39;)
       .putFile(image);
   StorageTaskSnapshot storageSnap = await uploadTask.onComplete;
   String downloadUrl = await storageSnap.ref.getDownloadURL();
   return downloadUrl;
 }
 
 static Future&lt;File&gt; compressImage(String photoId, File image) async {
   final tempDir = await getTemporaryDirectory();
   final path = tempDir.path;
   File compressedImageFile = await FlutterImageCompress.compressAndGetFile(
     image.absolute.path,
     &#39;$path/img_$photoId.jpg&#39;,
     quality: 70,
   );
   return compressedImageFile;
 }
}
</code></pre>
<p>We used few new packages in the new code lets add them to <code>pubspec.yaml</code> and run <code>flutter pub get</code></p>
<pre><code>dependencies:
	flutter_image_compress: ^0.6.5+1
  path_provider: ^1.6.5
  uuid: ^2.0.4
  image_picker: ^0.6.3+4
</code></pre>
<p>You can install packages from the command line:</p>
<pre><code>flutter pub get
</code></pre>
<aside class="special"><p>Links for the packages:<br><a href="https://pub.dev/packages/flutter_image_compress" target="_blank">flutter_image_compress</a><a href="https://pub.dev/packages/path_provider" target="_blank"><br>path_provider</a><a href="https://pub.dev/packages/uuid" target="_blank"><br>uuid</a><a href="https://pub.dev/packages/image_picker" target="_blank"><br>image_picker</a></p>
</aside>
<aside class="warning"><p>iOS need some special setting in the <code>&lt;project root&gt;/ios/Runner/Info.plist</code>. Please refeer to the readme tab for <a href="https://pub.dev/packages/image_picker#ios" target="_blank">image_picker</a>.<br>We will only need to specify <code>NSPhotoLibraryUsageDescription</code> and <code>NSCameraUsageDescription</code> in the <code>Info.plist</code>.</p>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="Task: Update the Chat Screen" duration="0">
        <p>Now let us finish the chat application and save the chat messages to the database (Firestore)</p>
<h2 is-upgraded>Database Service</h2>
<p>We will update the <code>DatabaseService</code></p>
<pre><code>Future&lt;List&lt;Message&gt;&gt; getChatMessages(String senderId, String receiverId) async {
   List&lt;Message&gt; messages = [];
   QuerySnapshot messagesSenderQuerySnapshot = await chatsRef
       .where(&#39;senderId&#39;, isEqualTo: senderId)
       .where(&#39;toUserId&#39;, isEqualTo: receiverId)
       .orderBy(&#39;timestamp&#39;, descending: true)
       .getDocuments();
 
   messagesSenderQuerySnapshot.documents.forEach((doc) {
     print(doc.documentID);
     messages.add(Message.fromDoc(doc));
   });
   QuerySnapshot messagestoQuerySnapshot = await chatsRef
       .where(&#39;senderId&#39;, isEqualTo: receiverId)
       .where(&#39;toUserId&#39;, isEqualTo: senderId)
       .orderBy(&#39;timestamp&#39;, descending: true)
       .getDocuments();
 
   messagestoQuerySnapshot.documents.forEach((doc) {
     print(doc.documentID);
     messages.add(Message.fromDoc(doc));
   });
 
   Comparator&lt;Message&gt; timestampComparator =
       (a, b) =&gt; b.timestamp.compareTo(a.timestamp);
   messages.sort(timestampComparator);
   return messages;
}
 
void sendChatMessage(Message message) {
   chatsRef.add({
     &#39;senderId&#39;: message.senderId,
     &#39;toUserId&#39;: message.toUserId,
     &#39;text&#39;: message.text,
     &#39;imageUrl&#39;: message.imageUrl,
     &#39;isLiked&#39;: message.isLiked,
     &#39;unread&#39;: message.unread,
     &#39;timestamp&#39;: Timestamp.fromDate(DateTime.now()),
   });
}
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Task: Update Message Model" duration="0">
        <p>We need to update our <code>Message</code> model, and introduce &#34;from sender&#34; and &#34;to sender&#34; and new fields, also it will have a function that maps database values into objects.</p>
<pre><code>class Message {
  final String id, senderId, toUserId, text, imageUrl;
  final bool isLiked;
  final bool unread;
  final Timestamp timestamp;
 
  Message({
    this.id,
    this.senderId,
    this.toUserId,
    this.text,
    this.imageUrl,
    this.isLiked,
    this.unread,
    this.timestamp,
  });
 
  factory Message.fromDoc(DocumentSnapshot doc) {
    return Message(
        id: doc.documentID,
        senderId: doc[&#39;senderId&#39;],
        toUserId: doc[&#39;toUserId&#39;],
        text: doc[&#39;text&#39;],
        imageUrl: doc[&#39;imageUrl&#39;],
        isLiked: doc[&#39;isLiked&#39;],
        unread: doc[&#39;unread&#39;],
        timestamp: doc[&#39;timestamp&#39;]);
  }
}
</code></pre>
<p>We will add <code>dateFormat</code> to our <code>constants.dart</code> file</p>
<pre><code>final DateFormat timeFormat = DateFormat(&#39;E, h:mm a&#39;);
</code></pre>
<p>We will use <code>intl</code> package to use <code>DateFormat</code>.<br>Add this to your package&#39;s <code>pubspec.yaml</code> file:</p>
<pre><code>dependencies:
  intl: ^0.16.1
</code></pre>
<p>Remember to get the dependencies by running this command</p>
<pre><code>flutter pub get
</code></pre>
<aside class="special"><p>You can find the latest version <a href="https://pub.dev/packages/intl#-installing-tab-" target="_blank">here</a>.</p>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="Task: Refactor Chat Screen" duration="0">
        <p>That <code>chat_screen.dart</code> will need to take 2 parameters, from which user message is coming from and to sender.</p>
<pre><code> final String currentUserId;
 final String toUserId;
 
 ChatScreen({this.currentUserId, this.toUserId});
</code></pre>
<p>We need to bring messages from our database.</p>
<p>Therefore, delete this as it won&#39;t be needed.</p>
<pre><code>final List&lt;Message&gt; _messages = messages;
</code></pre>
<p>And instead add this.</p>
<pre><code>DataBaseService _dataBaseService;
List&lt;Message&gt; _messages = [];
 
@override
void initState() {
   super.initState();
     _dataBaseService = Provider.of&lt;DataBaseService&gt;(context, listen: false);
 
   _setupMessages();
}
 
_setupMessages() async {
   List&lt;Message&gt; messages = await _dataBaseService.getChatMessages(
       widget.currentUserId, widget.toUserId);
   setState(() {
     _messages = messages;
   });
}
</code></pre>
<p>Update message time with this.</p>
<pre><code>...
Text(&#39;${timeFormat.format(message.timestamp.toDate())}&#39;,
...)
</code></pre>
<p>In <code>_handleSubmitted(...)</code> update code to pass the new values and call the database service.</p>
<pre><code>void _handleSubmitted(String text) {
   _textMessageController.clear();
 
   setState(() {
     _isComposing = false;
   });
   Message message = Message(
     senderId: widget.currentUserId,
     toUserId: widget.toUserId,
     timestamp: Timestamp.fromDate(DateTime.now()),
     text: text,
     isLiked: true,
     unread: true,
   );
   setState(() {
     _messages.insert(0, message);
   });
   
   _dataBaseService.sendChatMessage(message);
}
</code></pre>
<p>And finally update the <code>isMe</code> code to get value from the widget.</p>
<pre><code>final bool isMe = message.senderId == widget.currentUserId;
</code></pre>
<h2 is-upgraded>Update <code>all_attendees_widget</code></h2>
<p>Chat screen is called through the attendees screen. Therefore, we need to update the <code>all_attendees_widget.dart</code>.</p>
<p>In the <code>build</code> method we need to get the current user id.</p>
<pre><code>Widget build(BuildContext context) {
    String currentUserId = Provider.of&lt;UserData&gt;(context, listen: false).currentUserId;
		...
</code></pre>
<p>We then need to pass it to <code>ChatScreen</code> when we do the navigation.</p>
<pre><code>return GestureDetector(
    onTap: () =&gt; Navigator.push(
      context,
      MaterialPageRoute(
        builder: (_) =&gt; ChatScreen(
          currentUserId: currentUserId,
          toUserId: user.id,
        ),
      ),
    ),
  ...
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Task: Sending Pictures in Messages" duration="0">
        <p>We would like to send pictures in the chat.</p>
<p>So in our <code>storage_service.dart</code> we will add a new function <code>uploadMessageImage</code>.</p>
<pre><code>Future&lt;String&gt; uploadMessageImage(File imageFile) async {
   String imageId = Uuid().v4();
   File image = await compressImage(imageId, imageFile);
 
   String downloadUrl = await _uploadImage(
     &#39;images/messages/message_$imageId.jpg&#39;,
     imageId,
     image,
   );
   return downloadUrl;
}
</code></pre>
<p>In <code>chat_screen.dart</code> we will then update <code>_buildMessage()</code>.</p>
<pre><code>...
	children: &lt;Widget&gt;[
           message.imageUrl == null
               ? _buildText(isMe, message)
               : _buildImage(context, message),
           SizedBox(height: 8.0),
  ...
</code></pre>
<p>We will also add new methods before the build.</p>
<pre><code>_buildText(bool isMe,Message message) {
   return Text(
             message.text,
             style: TextStyle(
               color: isMe ? Colors.white60 : Colors.blueGrey,
               fontSize: 12.0,
               fontWeight: FontWeight.w600,
             ),
           );
}

_buildImage(BuildContext context,Message message) {
   final size = MediaQuery.of(context).size;
   return Container(
     height: size.height * 0.2,
     width: size.width * 0.6,
     decoration: BoxDecoration(
         borderRadius: BorderRadius.circular(20.0),
         image: DecorationImage(
           fit: BoxFit.cover,
           image: CachedNetworkImageProvider(message.imageUrl),
         )),
   );
}
</code></pre>
<p>Add to <code>onPressed</code> of our camera icon.</p>
<pre><code>...
	children: &lt;Widget&gt;[
         RawMaterialButton(
           onPressed: () async {
             File imageFile = await ImagePicker.pickImage(
               source: ImageSource.gallery,
             );
             if (imageFile != null) {
               String imageUrl =
                   await Provider.of&lt;StorageService&gt;(context, listen: false)
                       .uploadMessageImage(imageFile);
               _handleSubmitted(null, imageUrl);
             }
           },
  ...
</code></pre>
<p>Update <code>_handleSubmitted</code> to take an additional parameter.</p>
<pre><code>void _handleSubmitted(String text, String imageUrl) {
   if ((text != null &amp;&amp; text.trim().isNotEmpty) || imageUrl != null) {
     if (imageUrl == null) {
       //text message
 
       setState(() {
         _isComposing = false;
       });
     }
     Message message = Message(
       senderId: widget.currentUserId,
       toUserId: widget.toUserId,
       imageUrl: imageUrl,
       timestamp: Timestamp.fromDate(DateTime.now()),
       text: text,
       isLiked: true,
       unread: true,
     );
     setState(() {
       _messages.insert(0, message);
     });
     _dataBaseService.sendChatMessage(message);
   }
}
</code></pre>
<p>And update its usages</p>
<pre><code>...
  	onPressed: _isComposing
               ? () =&gt; _handleSubmitted(
                     _textMessageController.text,
                     null,
                   )
               : null,
...
</code></pre>
<p>Finally we should add a <code>Provider</code> for the <code>StorageService</code> class in <code>main.dart</code></p>
<pre><code>...
Provider&lt;StorageService&gt;(
   create: (_) =&gt; StorageService(),
),
...
</code></pre>
<h2 is-upgraded>Add Image in App Bar</h2>
<p>On the <code>chat_screen.dart</code> lets add whom we modify the app bar to include profile image and name.</p>
<pre><code>...
  appBar: AppBar(
       title: Row(
         children: &lt;Widget&gt;[
           CircleAvatar(
               radius: 25.0,
               backgroundImage: widget.toUser.profileImageUrl.isEmpty
                   ? // Display placeholder
                   AssetImage(&#39;assets/images/user_placeholder.jpg&#39;)
                   : CachedNetworkImageProvider(
                       widget.toUser.profileImageUrl)),
           SizedBox(width: 10.0),
           Text(
             widget.toUser.name,
             style: TextStyle(
               fontSize: 18.0,
               fontWeight: FontWeight.bold,
             ),
           ),
         ],
       ),
       elevation: 10.0,       
     ),
...
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="The End" duration="0">
        <p>TODO: Have links and other stuff</p>


      </google-codelab-step>
    
  </google-codelab>

  <script src="https://storage.googleapis.com/codelab-elements/native-shim.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/custom-elements.min.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/prettify.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/codelab-elements.js"></script>

</body>
</html>
